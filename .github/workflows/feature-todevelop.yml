name: Feature to Develop branch Pull Request

on:
  pull_request:
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Build with Maven
        run: mvn clean verify

      - name: Generate JaCoCo Badges for Unit Tests
        id: jacocoUnit
        uses: cicirello/jacoco-badge-generator@v2
        with:
          generate-branches-badge: true
          jacoco-csv-file: target/site/jacoco-ut/jacoco.csv
          coverage-badge-filename: unit.svg
          branches-badge-filename: unit-branch.svg
          coverage-label: coverage (unit tests)
          branches-label: branches (unit tests)
          fail-if-coverage-less-than: 80
#          fail-if-branches-less-than: 80

      - name: Generate JaCoCo Badges for Integration tests
        id: jacocoIntegration
        uses: cicirello/jacoco-badge-generator@v2
        with:
          generate-branches-badge: true
          jacoco-csv-file: target/site/jacoco-it/jacoco.csv
          coverage-badge-filename: integration.svg
          branches-badge-filename: integration-branch.svg
          coverage-label: coverage (integration tests)
          branches-label: branches (integration tests)
          fail-if-coverage-less-than: 70
#          fail-if-branches-less-than: 65

      - name: Log coverage percentage
        run: |
          echo "coverage = ${{ steps.jacoco.outputs.coverage }}"
          echo "branch coverage = ${{ steps.jacoco.outputs.branches }}"

      - name: Commit the badge (if it changed)
        run: |
          if [[ `git status --porcelain` ]]; then
          git config --global user.name 'Abran Lezama'
          git config --global user.email 'stay-fcsd@users.noreply.github.com'
          git add -A
          git commit -m "Autogenerated JaCoCo coverage badge"
          git push origin HEAD:dev
          fi

      - name: Upload JaCoCo coverage report
        uses: actions/upload-artifact@v2
        with:
          name: jacoco-report
          path: target/site/jacoco/
