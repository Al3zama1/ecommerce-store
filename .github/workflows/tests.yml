name: Tests and Code Coverage

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Build with Maven
        run: mvn clean verify

      - name: Generate JaCoCo Badges for Unit Tests
        id: jacocoUnit
        uses: cicirello/jacoco-badge-generator@v2
        with:
          generate-branches-badge: true
          jacoco-csv-file: target/site/jacoco-ut/jacoco.csv
          coverage-badge-filename: unit.svg
          branches-badge-filename: unit-branch.svg
          coverage-label: coverage (unit tests)
          branches-label: branches (unit tests)

      - name: Generate JaCoCo Badges for Integration tests
        id: jacocoIntegration
        uses: cicirello/jacoco-badge-generator@v2
        with:
          generate-branches-badge: true
          jacoco-csv-file: target/site/jacoco-it/jacoco.csv
          coverage-badge-filename: integration.svg
          branches-badge-filename: integration-branch.svg
          coverage-label: coverage (integration tests)
          branches-label: branches (integration tests)

      - name: Log coverage percentage
        run: |
          echo "coverage = ${{ steps.jacoco.outputs.coverage }}"
          echo "branch coverage = ${{ steps.jacoco.outputs.branches }}"

      - name: Commit the badge (if it changed)
        run: |
          if [[ `git status --porcelain` ]]; then
          git config --global user.name 'Abran Lezama'
          git config --global user.email 'stay-fcsd@users.noreply.github.com'
          git add -A
          git commit -m "Autogenerated JaCoCo coverage badge"
          git push
          fi

      - name: Upload JaCoCo coverage report
        uses: actions/upload-artifact@v2
        with:
          name: jacoco-report
          path: target/site/jacoco/


#      - name: Upload unit test coverage reports
#        uses: actions/upload-artifact@v2
#        with:
#          name: unit-coverage-report
#          path: target/site/jacoco-ut/index.html
#
#      - name: Upload integration test coverage report
#        uses: actions/upload-artifact@v2
#        with:
#          name: integration-coverage-report
#          path: target/site/jacoco-it/index.html
#
#      - name: Publish integration test results
#        uses: actions/upload-artifact@v2
#        with:
#          name: it-test-results
#          path: target/failsafe-reports
#
#      - name: Publish unit test results
#        uses: actions/upload-artifact@v2
#        with:
#          name: ut-test-results
#          path: target/surefire-reports
#
#      - name: Update badges
#        uses: actions/github-script@v4
#        with:
#          script: |
#            const fs = require('fs');
#            let readmeContent = fs.readFileSync('README.md', 'utf8');
#            readmeContent = readmeContent.replace(/!\[Unit Coverage\]\([^)]*\)/, `![Unit Coverage](${{ github.server_url }}/artifacts/$GITHUB_RUN_ID/attachments/unit-coverage-report/index.html)`);
#            readmeContent = readmeContent.replace(/!\[Integration Coverage\]\([^)]*\)/, `![Integration Coverage](${{ github.server_url }}/artifacts/$GITHUB_RUN_ID/attachments/integration-coverage-report/index.html)`);
#            fs.writeFileSync('README.md', readmeContent);
